https://developer.aliyun.com/article/762599

## 前端性能优化：当页面渲染遇上边缘计算

#### 背景
对于web页面来说，*首跳页面场景*（例如SEO、付费引流）的性能普遍比二跳性能要差。原因主要是首跳用户无法使用连接复用和浏览器缓存。首跳场景在端上的优化手段（预加载，预执行、预渲染等）无法实施。

#### 首跳场景下的优化思路
##### 思路一：SSR
直接通过服务端渲染（SSR）,将首屏动态内容从服务端输出。

![这是图片](./assets/ESR-1.png)

优点：一次性返回html页面的主体内容，不用通过请求接口数据用js渲染页面内容；
缺点：对于距离服务端远，或者服务端处理时间长的场景，需要等服务器处理完内容之后返回，即使返回html，还需要加载完js、css等静态资源后，才能看到内容，*白屏时间长*。

##### 思路二：CSR + CDN
利用CDN边缘缓存能力，把html的静态框架部分缓存只CDN上，让用户能快速看到部分内容，通过异步请求获取动态内容部分并渲染（CSR），从而减少白屏时间。CSR + CDN时序图：

![这是图片](./assets/ESR-2.png)

优点：用户可以快速看到部分页面内容，白屏时间更少；
缺点：最终有意义的动态内容展示的时间比SSR更长。

##### 思路三：ESI
CSR+CDN可以减少白屏时间，但是动态内容展示时间过长。分析其原因是，用户需要先发起获取html静态框架请求，之后开始发起异步请求获取动态内容，这两个操作是串行的，且串行的过程中还穿插着js的下载和执行。

那么如何利用CDN把静态内容和动态内容整合起来呢？

ESI (Edge Side Include) 给了我们一个很好的思路启发，ESI 最初也是 CDN 服务商们提出的规范，可通过 html 标签里加特定的动态标签，可让页面的静态内容缓存在 cdn 上，动态内容可以自由组装。ESI 的渲染时序图如下：

![这是图片](./assets/ESR-3.png)

ESI可以把静态部分缓存在CDN,动态部分会在用户请求时会动态请求和拼接。但是ESI模式下，最终返回给用户的首字节，还是要等到所有动态内容在CDN上都获取和拼接完成。也就是说没有减少白屏时间，只是减少了CDN和服务器之间内容传输的体积，带来的性能收益很小。最终效果和SSR区别不大。

虽然ESI的效果不符合预期，但是有了思考的方向。如果能把ESI改造成可以先返回静态内容，动态内容在CDN节点获取到之后再返回给页面，就可以保证*白屏时间短*且*动态内容返回不推迟*。如果要实现类似流式ESI效果，要求在CDN上能对请求进行细粒度的操作，已经流式的返回。CDN节点支持复杂运算吗？-- *边缘计算*。我们可以在CDN上做类似于浏览器的service worker操作，对请求和响应做灵活的变成。

----

**基于边缘计算能力，得出一个新方案：边缘流式方案（ESR）。方案详情：**

#### 渲染流程
方案的核心思想是，借助边缘计算的能力，将静态内容与动态内容以流式的方式，先后返回给用户。cdn 节点相比于 server，距离用户更近，有着更短的网络延时。在 cdn 节点上，将可缓存的页面静态部分，先快速返回给用户，同时在 cdn 节点上发起动态部分内容请求，并将动态内容在静态部分的响应流后，继续返回给用户。最终页面渲染的时序图如下：

![这是图片](./assets/ESR-4.png)

从上图可以看出，cdn 边缘节点可以很快地返回首字节和页面静态部分内容，然后动态内容由 cdn 发起向 server 起并流式返回给用户。方案有以下特点：

首屏 ttfb 会很短，静态内容（例如页面 Header 、基本结构、骨骼图）可以很快看到。
动态内容是由 cdn 发起，相比于传统浏览器渲染，发起时间更早，且不依赖浏览器上下载和执行 js。理论上，最终 reponse 完结时间，与直接访问服务器获取完整动态页面时间一致。
在静态内容返回后，已经可以开始部分 html 的解析，以及 js, css 的下载和执行。把一些阻塞页面的操作提前进行，等完整动态内容流式返回后，可以更快地展示动态内容。
边缘节点与服务端之间的网络，相比于客户端与服务端之间的网络，更有优化空间。例如通过动态加速，以及 edge 与 server 之间的连接复用，能为动态请求减少 tcp 建连和网络传输开销。以做到最终动态内容的返回时间，比 client 直接访问 server 更快。

#### demo 对比

目前在 alicdn 上对主搜页面做了一个 demo （https://edge-routine.m.alibaba.com/）, 下面是在不同网络（通过 charles 的 network throttle 配置限速）情况下，与原始页面的加载对比：

**不限速（wifi）**
![这是图片](./assets/ESR-5.png)

**限速 4G**
![这是图片](./assets/ESR-6.png)

**限速 5G**
![这是图片](./assets/ESR-7.png)

从上面结果可以看出，在网速越慢的情况下，通过 cdn 流式渲染的最终主要元素出来的时间比原始 ssr 的方式出来得越早。这与实际推论也符合，因为网络越慢，静态资源加载时间越慢，对应的浏览器提前加载静态资源带来的效果也越明显。另外，不管在什么网络情况下，cdn 流式渲染方式的白屏时间要短很多。